---
title: "Exploration des données DHS"
subtitle: "Présentation, accès et contenu des donnèes, "
date: "`r Sys.Date()`"
author: 
 - name: Hugues Pecout
   affiliation: CNRS, FR CIST
image: "featured.jpg"   
logo: "figures/usaid.png"  
output:
  rzine::readrzine:
    highlight: kate
    number_sections: true
csl: Rzine_citation.csl
bibliography: biblio.bib
nocite: |
  @*
link-citations: true
licence: "[![licensebuttons by-sa](https://licensebuttons.net/l/by-sa/3.0/88x31.png)](https://creativecommons.org/licenses/by-sa/4.0)"
giturl: "[![Code source on GitHub](https://badgen.net/badge/Code%20source%20on%20/GitHub/blue?icon=github)](https://github.com/HuguesPecout/EXPLO_DHS_DATA)"
#doi: "[![DOI:xxx](https://zenodo.org/badge/DOI/xxx.svg)](https://doi.org/xxx)"
---

```{r setup, include=FALSE}

library(knitr)
library(rzine)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               class.source="bg-info",
               class.output="bg-warning")

# opts_knit$set(width=75)
```



# The DHS Program {-}

Le [programme DHS](https://www.dhsprogram.com/) est un programme d'enquêtes démographiques et de santé (EDS) de l'[United States Agency for International Development](https://www.usaid.gov/).

**Ce programme a collecté, analysé et diffuse des données précises et représentatives sur la population, la santé, le VIH et la nutrition à travers plus de 400 enquêtes dans plus de 90 pays, depuis plus de 30 ans :**

```{r,  echo=FALSE, out.width="100%",  fig.align = 'center'}
knitr::include_graphics("figures/carte_DHS.png")
```

</br>



# Les donnèes

L'accées aux données est gratuite, mais **il est obligatoire de** [**réaliser une demande justifiée**](https://dhsprogram.com/data/new-user-registration.cfm) **pour avoir d'un compte utilisateur permettant le téléchargement des données individuelles**.

<div class="alert alert-danger" role="alert">
**Seules des données aggrégés à des niveaux régionaux (départements pour le Bénin), et un jeu de données individuelles modèle (exemple) sont accessibles sans création de compte** [**(cf partie 1.2)**](#indicateurs-disponibles).</div>

</br>

## Questionnaire DHS

Beaucoup de documentation sur les méthodes d'enquête et les donnèes est mis à disposition : 


1) [**Guide to DHS Statistics** V7](https://dhsprogram.com/Data/Guide-to-DHS-Statistics/index.cfm)    
2) [**Modèle de questionnaire** V6](https://www.dhsprogram.com/publications/publication-dhsq6-dhs-questionnaires-and-manuals.cfm)    
3) [**Information sur les donnèes** V6](https://www.dhsprogram.com/publications/publication-dhsg4-dhs-questionnaires-and-manuals.cfm)   

</br>

## Jeu de données exemple

**Néanmoins, le programme DHS a créé des exemples d'ensembles de données individuelles avec lesquels les utilisateurs peuvent s'exercer**. Ces ensembles de données ont été créés strictement pour la pratique et ne représentent pas les données réelles d'un pays. Ces ensembles de données sont basés sur le questionnaire *DHS6* et *Recode*. **Vous n'avez pas besoin de vous inscrire pour télécharger ces données.**


```{r,  echo=FALSE, out.width="100%",  fig.align = 'center', fig.cap="https://dhsprogram.com/data/Download-Model-Datasets.cfm"}
knitr::include_graphics("figures/example.png")
```


Les exemples exemples d'ensembles de données sont mis à disposition dans **quatre formats** :   
- *Stata dataset (.dta)*      
- *Flat ASCII data (.dat)*     
- *SAS dataset (.sas7bdat)*     
- *SPSS dataset (.sav)*    

Et parfois en *Hierarchical ASCII data (.dat)*

Les données sont proposées aux téléchargement par groupes d'individus ou thématiques :    
- Births   
- Couple   
- Household   
- Individual   
- Children   
- Men   
- Household member   
- HIV Test results   



<div class="alert alert-danger" role="alert">
**La localisation GPS des individus ne semble pas être fournie dans le jeu de donnèes exemple...**</div>

</br>

### Import des données exemple

**-> Test d'import des donnèes "household" au format SPSS (.sav) :**

```{r,  eval= TRUE, echo=TRUE, cache=TRUE}

library(haven)
data_ex <- read_sav("model/zzhr62sv/ZZHR62FL.SAV")

```

</br>

### Liste des variables (avec label)

```{r,  eval= TRUE, echo=TRUE, cache=TRUE}

# AFFICHER LE LABEL D'UNE VARIABLE
attr(data_ex$HV028, "label")

# AFFICHER LES LABELS DE TOUTES LES VARIABLES (Code + label)
l <- lapply(data_ex, attr, "label")
l <- as.data.frame(l, stringsAsFactors = F)
list_var <- as.data.frame(t(l))

library(DT)
datatable(list_var, options = list(
                                        autoWidth = TRUE, 
                                        rownames = FALSE,
                                        pageLength =NULL))

```

</br>

### Liste des modalités (avec label)

```{r,  eval= TRUE, echo=TRUE, cache=TRUE}
# POUR UNE SEULE VARIABLE
attr(data_ex[["HV023"]], "labels")

# POUR TOUTES LES VARIABLES
library(sjlabelled)
get_labels(data_ex)

```

</br>

## Couverture du Bénin

Le Bénin fait partie des [pays ciblés par les enquêtes](https://dhsprogram.com/Countries/). Dans le cadre de ce programme, [**l'enquête standard DHS a été réalisées 5 fois**](https://dhsprogram.com/methodology/survey-search.cfm?sendsearch=1&str1=52&crt=1&listgrp=3) sur ce pays, aux dates suivantes : **1996**, **2001**, **2006**, **2011-2012**, **2017-2018**.

Voici un aperçu de **quelques indicateurs collectés** (valeur nationnale) et leur **disponibilité par dates** :

```{r,  echo=FALSE, cache=TRUE}

library(xlsx)
Benin_indicator <- read.xlsx(file = "figures/STATcompilerExport2021916_1595.xlsx", 
                             sheetIndex = 1,
                             startRow = 4,
                             endRow = 34)

Benin_indicator <- Benin_indicator[, c(1,  8:4)]
colnames(Benin_indicator) <- c("Indicator",
                               "1996",
                               "2001",
                               "2006",
                               "2011-2012",
                               "2017-2018")


datatable(Benin_indicator, options = list(
                                        autoWidth = TRUE, 
                                        rownames = FALSE,
                                        pageLength =NULL))
```

<div class="alert alert-danger" role="alert">
Il semblerait que **la localisation GPS des individus enquêtés ne soit pas disponible pour 2006**.</div>

</br>

## Indicateurs disponibles

**Le package R** [`rdhs`](https://docs.ropensci.org/rdhs/), développé par OJ.. Watson & J. Eaton et soutenu par [rOpenSCi](https://ropensci.org/), **permet d'accéder directement aux données avec R**. 

**Ce package fournit un client pour :**    

1) **Interroger l'API des donnèes DHS** pour les indicateurs et les métadonnées d'enquête   
2) **Identifier les enquêtes et les ensembles de données** pour l'analyse   
3) **Télécharger les ensembles de données d'enquête** à partir du site Web de l'EDS   
4) **Charger les ensembles de données et les métadonnées associées** dans R   
5) **Extraire les variables et combiner les ensembles de données** pour une analyse groupée l'accessibilité de ces ensembles de données pour l'analyse statistique avec R    

<div class="alert alert-danger" role="alert">
**Il n'est pas nécéssaire d'avoir une compte utlisateur pour les étapes 1 et 2.** Il est donc possible d'explorer les données mises à disposition via R, sans s'enregistrer auprès du programme DHS</div>

</br>


## Le package `rdhs`

Pour récupérer à la table complète des indicateurs disponibles et à leurs caractèristiques :

```{r,  eval= TRUE, cache=TRUE}

# install.packages("rdhs")  
library(rdhs)

## what are the indicators ?
indicators <- dhs_indicators()

```

**Ci dessous, la liste des indicateurs (ID + définition) :**    

```{r,  eval= TRUE, echo=FALSE, cache=TRUE}


datatable(indicators[,c(7,1)], options = list(
                                        autoWidth = TRUE, 
                                        rownames = FALSE,
                                        pageLength = 5))

```


</br>

### Indicateurs pour le Bénin ?

Pour récuperer les **indicateurs par enquête (date) disponibles pour le Bénin ainsi que leurs valeurs aggréger à un niveau infra-nationnal**, il suffit d'utiliser la fonction *dhs_data()* :

```{r,  eval= TRUE, cache=TRUE}

# Make an api request
resp <- dhs_data(surveyYearStart = 1990,
                 breakdown = "subnational",
                 countryIds = "BJ")

str(resp)

```

**Nombre d'indicateurs disponibles par enquête pour le Bénin :**

```{r,  eval= TRUE, cache=TRUE}

# Group by Survey and indicator
temp <- aggregate(data = resp, Indicator ~ SurveyYearLabel + IndicatorId + IndicatorType, length)

# Count Number of indicator by survey
temp2 <- aggregate(data = temp, IndicatorId ~ SurveyYearLabel + IndicatorType, length)
colnames(temp2) <- c("Year_of_survey", "Type_Indicator", "Number_of_indicators_available")

# and plot the results
library(ggplot2)
ggplot(temp2, aes(x = Year_of_survey, y = Number_of_indicators_available, 
       fill = Type_Indicator)) +
  geom_bar(stat='identity')

```

**Nombre d'indicateurs disponibles à chaque date pour le Bénin (depuis 1996) :**

```{r,  eval= TRUE, cache=TRUE}


temp3 <- aggregate(data = temp, SurveyYearLabel ~ IndicatorId, length)
temp3 <- temp3[temp3$SurveyYearLabel>=5,]

# Nombre d'indicateurs présents à toutes les dates :
print(nrow(temp3))

```

</br>

### Donnèes aggrégées pour le Bénin ?

**Les donnèes individuelles aggégées aux départements sont directement mis à disposition.**

Exemple pour l'indicateur "Total fertility rate 15-49" (*FE_FRTR_W_TFR*), en 2012 : 

```{r,  eval= TRUE, cache=TRUE}

resp2 <- dhs_data(indicatorIds = "FE_FRTR_W_TFR", 
                 surveyYearStart = 2012, 
                 surveyYearEnd = 2012,
                 breakdown = "subnational", 
                 countryIds = "BJ")


datatable(resp2[, c("CharacteristicLabel", "Value")], 
          options = list(autoWidth = TRUE, 
                         rownames = FALSE,
                         pageLength = 18))


```

Le données sont également aggrégées par couple de département.

<div class="alert alert-danger" role="alert">
**Il n'y a malheureusement pas de clef de jointure fournies dans ces extraction les relier facilement à une couche géographique...**

**Une table de correspondance est mis à disposition à ce** [**lien**](https://github.com/HuguesPecout/EXPLO_DHS_DATA/raw/main/table_passage_nom_ISO_Dep_Benin)</div>

Pour récupérer les géométries du découpage administratif du Bénin directement depuis R, il est possible d'utiliser le package `gadmr`


```{r,  eval= TRUE, cache=TRUE}

if(!require(remotes)) install.packages("remotes")
if(!require(gadmr)) remotes::install_github("SpatialWorks/gadmr")

library(gadmr)
# Téléchargement 
benin_sp <- get_geopackage(country = "BEN",  layer = 1)

# Conversion objet sp to sf
library(sf)
benin_sf <- st_as_sf(benin_sp)

# Chargement table de correspondance (à télécharger)
table <- readRDS("table_passage_nom_ISO_Dep_Benin")

# Merge avec la table de correspondance
benin_sf <- merge(benin_sf, table, by.x="HASC_1", by.y="ISO" )

# Merge avec les données
benin_sf <- merge(benin_sf, resp2, by.x="NAME_dhs", by.y="CharacteristicLabel" )

# Cartography
library(mapsf)
mf_theme("agolalight")
mf_map(benin_sf, var = "Value", type = "choro", leg_pos = "left")
mf_layout(title = "Total fertility rate 15-49, 2012",
          credits = "DHS program, 2012",
          scale = FALSE,
          arrow = TRUE,
          frame = TRUE)
mf_inset_on(x = "worldmap")
mf_worldmap(benin_sf)
mf_inset_off()


```

</br>


# Donnée individuelles

## S'enregistrer

## Exploration des donnèes











# Bibliographie {-}

<div id="refs"></div>


# Annexes {-}


## Infos session  {-}

```{r session_info, echo=FALSE}
kableExtra::kable_styling(kable(sessionRzine()[[1]], row.names = F))
kableExtra::kable_styling(kable(sessionRzine()[[2]], row.names = F))


```



<br>


